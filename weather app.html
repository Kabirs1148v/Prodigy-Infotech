<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Weather Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #10b981;
      --dark: #1e293b;
      --darker: #0f172a;
      --light: #f8fafc;
    }

    * {
      transition: all 0.3s ease;
    }

    body {
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      position: relative;
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(21, 101, 216, 0.85) 0%, rgba(9, 73, 163, 0.9) 100%);
      z-index: 1;
    }

    .container {
      position: relative;
      z-index: 10;
      animation: fadeIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      backdrop-filter: blur(12px);
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    .autocomplete-items {
      position: absolute;
      background: white;
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      z-index: 20;
      top: 100%;
      margin-top: 5px;
    }

    .autocomplete-item {
      padding: 12px 16px;
      cursor: pointer;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #f1f5f9;
    }

    .autocomplete-item:hover,
    .autocomplete-item:focus {
      background: #f8fafc;
      outline: 2px solid var(--primary);
      outline-offset: -2px;
    }

    .weather-card {
      background: rgba(255, 255, 255, 0.12);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .hourly-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      padding: 15px;
      min-width: 120px;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .forecast-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 18px 12px;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .detail-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      padding: 15px;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .scrollbar-thin {
      scrollbar-width: thin;
      scrollbar-color: #94a3b8 rgba(241, 245, 249, 0.1);
    }

    .scrollbar-thin::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: #94a3b8;
      border-radius: 4px;
    }

    .scrollbar-thin::-webkit-scrollbar-track {
      background: rgba(241, 245, 249, 0.1);
      border-radius: 4px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }

    .floating {
      animation: float 6s ease-in-out infinite;
    }

    .temp-display {
      font-size: 4.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #fff 0%, #e0f2fe 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    .weather-icon {
      filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.25));
    }

    .search-btn {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }

    .search-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
    }

    .geo-btn {
      background: linear-gradient(135deg, var(--secondary) 0%, #059669 100%);
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }

    .geo-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
    }

    .unit-toggle {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .unit-toggle:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
    }

    .theme-toggle {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: scale(1.1);
    }

    .share-btn {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .share-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: scale(1.1);
    }

    .favorite-btn {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .favorite-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: scale(1.1);
    }

    .country-flag {
      width: 24px;
      height: 16px;
      border-radius: 2px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .chart-container {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 sm:p-6">
  <div id="loading" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
    <div class="spinner" role="status" aria-label="Loading"></div>
  </div>

  <div class="container bg-white/5 text-white p-6 sm:p-8 rounded-2xl w-full max-w-4xl">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-8">
      <div>
        <h1 class="text-3xl sm:text-4xl font-bold">Weather Pro</h1>
        <p class="text-blue-100 mt-1 text-sm sm:text-base">Accurate forecasts & real-time data</p>
      </div>
      <div class="flex gap-3 mt-4 sm:mt-0">
        <button id="favoriteBtn" class="favorite-btn p-3 rounded-xl" title="Add to Favorites" aria-label="Add to Favorites">
          <i class="fas fa-star text-lg"></i>
        </button>
        <button id="shareBtn" class="share-btn p-3 rounded-xl" title="Share Weather" aria-label="Share Weather">
          <i class="fas fa-share-alt text-lg"></i>
        </button>
        <button id="themeToggle" class="theme-toggle p-3 rounded-xl" aria-label="Toggle Theme">
          <i id="themeIcon" class="fas fa-moon text-lg"></i>
        </button>
      </div>
    </div>

    <div class="relative mb-6">
      <div class="flex flex-col sm:flex-row gap-3">
        <div class="relative flex-1">
          <input type="text" id="cityInput" placeholder="Search for a city..." class="w-full p-4 bg-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-300 placeholder-blue-100 pl-12 pr-12 text-sm sm:text-base" aria-label="Enter city name" autocomplete="off" />
          <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-blue-200"></i>
          <i id="clearInput" class="fas fa-times absolute right-4 top-1/2 transform -translate-y-1/2 text-blue-200 cursor-pointer hidden" aria-label="Clear input"></i>
          <div id="autocomplete" class="autocomplete-items hidden"></div>
        </div>
        <button id="searchBtn" class="search-btn p-4 rounded-xl font-medium text-sm sm:text-base">Search</button>
      </div>
    </div>

    <div class="flex flex-col sm:flex-row gap-3 mb-6">
      <button id="geoBtn" class="geo-btn p-4 rounded-xl font-medium flex items-center justify-center gap-2 text-sm sm:text-base">
        <i class="fas fa-location-arrow"></i> My Location
      </button>
      <button id="unitToggle" class="unit-toggle p-4 rounded-xl font-medium flex items-center justify-center text-sm sm:text-base">
        <span id="unitText">°C</span>
      </button>
    </div>

    <div id="alerts" class="bg-red-400/20 text-white p-4 rounded-xl mb-6 hidden" role="alert">
      <div class="flex items-start gap-3">
        <i class="fas fa-exclamation-triangle mt-1"></i>
        <div>
          <p id="alertMessage" class="text-sm"></p>
          <p id="alertSender" class="text-xs text-blue-100 mt-1"></p>
        </div>
      </div>
    </div>

    <div id="weatherInfo" class="weather-card text-center mb-8">
      <p id="error" class="text-red-300 hidden mb-4 text-sm" role="alert"></p>
      <div class="flex flex-col sm:flex-row items-center justify-between mb-6">
        <div class="text-left">
          <p id="location" class="text-2xl sm:text-3xl font-bold mb-1"></p>
          <p id="localTime" class="text-blue-100 text-sm"></p>
        </div>
        <div class="flex items-center justify-center my-4 sm:my-0">
          <img id="weatherIcon" class="weather-icon w-28 h-28 floating" alt="Weather Icon" />
        </div>
      </div>

      <div class="temp-display mb-2" id="temperature"></div>
      <p id="description" class="text-xl font-medium capitalize mb-8"></p>

      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-8">
        <div class="detail-card">
          <p class="text-blue-200 mb-1 text-sm"><i class="fas fa-wind mr-2"></i> Wind</p>
          <p id="wind" class="font-medium"></p>
        </div>
        <div class="detail-card">
          <p class="text-blue-200 mb-1 text-sm"><i class="fas fa-tint mr-2"></i> Humidity</p>
          <p id="humidity" class="font-medium"></p>
        </div>
        <div class="detail-card">
          <p class="text-blue-200 mb-1 text-sm"><i class="fas fa-cloud mr-2"></i> Clouds</p>
          <p id="clouds" class="font-medium"></p>
        </div>
        <div class="detail-card">
          <p class="text-blue-200 mb-1 text-sm"><i class="fas fa-compress mr-2"></i> Pressure</p>
          <p id="pressure" class="font-medium"></p>
        </div>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-8">
        <div class="detail-card">
          <p class="text-blue-200 mb-1 text-sm"><i class="fas fa-temperature-low mr-2"></i> Feels Like</p>
          <p id="feelsLike" class="font-medium"></p>
        </div>
        <div class="detail-card">
          <p class="text-blue-200 mb-1 text-sm"><i class="fas fa-eye mr-2"></i> Visibility</p>
          <p id="visibility" class="font-medium"></p>
        </div>
        <div class="detail-card">
          <p class="text-blue-200 mb-1 text-sm"><i class="fas fa-sun mr-2"></i> UV Index</p>
          <p id="uvIndex" class="font-medium"></p>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div class="detail-card">
          <p class="text-blue-200 mb-1 text-sm"><i class="fas fa-sunrise mr-2"></i> Sunrise</p>
          <p id="sunrise" class="font-medium"></p>
        </div>
        <div class="detail-card">
          <p class="text-blue-200 mb-1 text-sm"><i class="fas fa-sunset mr-2"></i> Sunset</p>
          <p id="sunset" class="font-medium"></p>
        </div>
      </div>

      <p id="lastUpdated" class="text-sm text-blue-100 mt-6"></p>
    </div>

    <h2 class="text-xl font-semibold mb-4">Temperature Trend (Hourly)</h2>
    <div class="chart-container mb-8">
      <canvas id="tempChart" height="100"></canvas>
    </div>

    <h2 class="text-xl font-semibold mb-4">Hourly Forecast</h2>
    <div id="hourlyForecast" class="flex overflow-x-auto gap-4 mb-8 pb-4 scrollbar-thin"></div>

    <h2 class="text-xl font-semibold mb-4">5-Day Forecast</h2>
    <div id="forecast" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 mb-8"></div>

    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">Favorite Cities</h2>
      <button id="clearFavorites" class="text-sm bg-white/10 hover:bg-white/20 px-3 py-1 rounded-lg">Clear Favorites</button>
    </div>
    <div id="favoriteCities" class="flex flex-wrap gap-3 mb-8"></div>

    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">Recent Searches</h2>
      <button id="clearRecent" class="text-sm bg-white/10 hover:bg-white/20 px-3 py-1 rounded-lg">Clear Recent</button>
    </div>
    <div id="recentSearches" class="flex flex-wrap gap-3"></div>
  </div>

  <script>
    const apiKey = '23975cd1f2ffd89252a40b7b54684d3d';
    const cityInput = document.getElementById('cityInput');
    const searchBtn = document.getElementById('searchBtn');
    const geoBtn = document.getElementById('geoBtn');
    const unitToggle = document.getElementById('unitToggle');
    const unitText = document.getElementById('unitText');
    const shareBtn = document.getElementById('shareBtn');
    const favoriteBtn = document.getElementById('favoriteBtn');
    const locationEl = document.getElementById('location');
    const localTimeEl = document.getElementById('localTime');
    const temperatureEl = document.getElementById('temperature');
    const feelsLikeEl = document.getElementById('feelsLike');
    const descriptionEl = document.getElementById('description');
    const weatherIcon = document.getElementById('weatherIcon');
    const humidityEl = document.getElementById('humidity');
    const windEl = document.getElementById('wind');
    const pressureEl = document.getElementById('pressure');
    const visibilityEl = document.getElementById('visibility');
    const uvIndexEl = document.getElementById('uvIndex');
    const cloudsEl = document.getElementById('clouds');
    const sunriseEl = document.getElementById('sunrise');
    const sunsetEl = document.getElementById('sunset');
    const errorEl = document.getElementById('error');
    const alertsEl = document.getElementById('alerts');
    const alertMessageEl = document.getElementById('alertMessage');
    const alertSenderEl = document.getElementById('alertSender');
    const forecastEl = document.getElementById('forecast');
    const hourlyForecastEl = document.getElementById('hourlyForecast');
    const favoriteCitiesEl = document.getElementById('favoriteCities');
    const recentSearchesEl = document.getElementById('recentSearches');
    const clearRecentBtn = document.getElementById('clearRecent');
    const clearFavoritesBtn = document.getElementById('clearFavorites');
    const lastUpdatedEl = document.getElementById('lastUpdated');
    const loadingEl = document.getElementById('loading');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const autocompleteEl = document.getElementById('autocomplete');
    const clearInput = document.getElementById('clearInput');
    const tempChartCanvas = document.getElementById('tempChart');

    let unit = localStorage.getItem('unit') || 'metric';
    let recentCities = JSON.parse(localStorage.getItem('recentCities')) || [];
    let favoriteCities = JSON.parse(localStorage.getItem('favoriteCities')) || [];
    let isDarkMode = localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
    let currentWeatherData = null;
    let lastSearchedCity = localStorage.getItem('lastSearchedCity') || 'New York';
    let debounceTimeout;
    let retryCount = 0;
    const maxRetries = 3;
    const CACHE_DURATION = 600000; // 10 minutes
    let tempChart = null;

    function setTheme(isDark) {
      isDarkMode = isDark;
      if (isDark) {
        document.body.style.backgroundImage = "linear-gradient(rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.9)), url('https://images.unsplash.com/photo-1534274988757-a28bf1a57c17?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80')";
        themeIcon.className = 'fas fa-sun text-lg';
      } else {
        document.body.style.backgroundImage = "linear-gradient(rgba(59, 130, 246, 0.85), rgba(37, 99, 235, 0.9)), url('https://images.unsplash.com/photo-1504608524841-42fe6f032b4b?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80')";
        themeIcon.className = 'fas fa-moon text-lg';
      }
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      updateChartTheme();
    }

    function setLoading(isLoading) {
      loadingEl.classList.toggle('hidden', !isLoading);
      loadingEl.setAttribute('aria-hidden', !isLoading);
    }

    function updateLastUpdated() {
      const now = new Date();
      lastUpdatedEl.textContent = `Last updated: ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
    }

    function saveRecentCity(city) {
      const normalizedCity = city.trim().toLowerCase();
      if (normalizedCity && !recentCities.includes(normalizedCity)) {
        recentCities.unshift(normalizedCity);
        if (recentCities.length > 5) recentCities.pop();
        localStorage.setItem('recentCities', JSON.stringify(recentCities));
        localStorage.setItem('lastSearchedCity', city);
        updateRecentSearches();
      }
    }

    function toggleFavoriteCity(city) {
      const normalizedCity = city.trim().toLowerCase();
      if (favoriteCities.includes(normalizedCity)) {
        favoriteCities = favoriteCities.filter(c => c !== normalizedCity);
        favoriteBtn.querySelector('i').className = 'fas fa-star text-lg';
        favoriteBtn.title = 'Add to Favorites';
        favoriteBtn.setAttribute('aria-label', 'Add to Favorites');
      } else {
        if (favoriteCities.length < 5) {
          favoriteCities.unshift(normalizedCity);
          favoriteBtn.querySelector('i').className = 'fas fa-star text-yellow-400';
          favoriteBtn.title = 'Remove from Favorites';
          favoriteBtn.setAttribute('aria-label', 'Remove from Favorites');
        } else {
          showError('Maximum 5 favorite cities allowed', false);
          return;
        }
      }
      localStorage.setItem('favoriteCities', JSON.stringify(favoriteCities));
      updateFavoriteCities();
    }

    function updateFavoriteCities() {
      favoriteCitiesEl.innerHTML = '';
      favoriteCities.forEach(city => {
        const btn = document.createElement('button');
        btn.className = 'bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg capitalize transition-colors text-sm';
        btn.textContent = city;
        btn.setAttribute('aria-label', `Search weather for ${city}`);
        btn.addEventListener('click', () => fetchWeatherByCity(city));
        favoriteCitiesEl.appendChild(btn);
      });
    }

    function updateRecentSearches() {
      recentSearchesEl.innerHTML = '';
      recentCities.forEach(city => {
        const btn = document.createElement('button');
        btn.className = 'bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg capitalize transition-colors text-sm';
        btn.textContent = city;
        btn.setAttribute('aria-label', `Search weather for ${city}`);
        btn.addEventListener('click', () => fetchWeatherByCity(city));
        recentSearchesEl.appendChild(btn);
      });
    }

    function clearRecentSearches() {
      recentCities = [];
      localStorage.removeItem('recentCities');
      localStorage.removeItem('lastSearchedCity');
      updateRecentSearches();
    }

    function clearFavoriteCities() {
      favoriteCities = [];
      localStorage.removeItem('favoriteCities');
      favoriteBtn.querySelector('i').className = 'fas fa-star text-lg';
      favoriteBtn.title = 'Add to Favorites';
      favoriteBtn.setAttribute('aria-label', 'Add to Favorites');
      updateFavoriteCities();
    }

    function getUVIndexText(uvi) {
      if (uvi <= 2) return `Low`;
      if (uvi <= 5) return `Moderate`;
      if (uvi <= 7) return `High`;
      if (uvi <= 10) return `Very High`;
      return `Extreme`;
    }

    function getUVIndexAdvice(uvi) {
      if (uvi <= 2) return `No protection needed`;
      if (uvi <= 5) return `Wear sunscreen`;
      if (uvi <= 7) return `Use sunscreen and hat`;
      if (uvi <= 10) return `Limit sun exposure`;
      return `Avoid sun exposure`;
    }

    function updateLocalTime(timezoneOffset) {
      const now = new Date();
      const locationDate = new Date(now.getTime() + timezoneOffset * 1000);
      const hours = locationDate.getUTCHours();
      const minutes = locationDate.getUTCMinutes();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const displayHours = hours % 12 || 12;
      localTimeEl.textContent = `Local Time: ${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
    }

    function formatTime(timestamp, timezoneOffset) {
      const date = new Date((timestamp + timezoneOffset) * 1000);
      const hours = date.getUTCHours();
      const minutes = date.getUTCMinutes();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const displayHours = hours % 12 || 12;
      return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
    }

    async function fetchCitySuggestions(query) {
      if (query.length < 2) {
        autocompleteEl.classList.add('hidden');
        return;
      }
      try {
        const response = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(query)}&limit=5&appid=${apiKey}`);
        if (!response.ok) throw new Error('Unable to fetch city suggestions');
        const data = await response.json();
        autocompleteEl.innerHTML = '';
        data.forEach(city => {
          const div = document.createElement('div');
          div.className = `autocomplete-item`;
          div.tabIndex = 0;
          div.innerHTML = `
            <img src="https://flagcdn.com/16x12/${city.country.toLowerCase()}.png" class="country-flag" alt="${city.country} flag">
            <div>
              <div class="font-medium">${city.name}${city.state ? `, ${city.state}` : ''}</div>
              <div class="text-sm text-gray-500">${city.country}</div>
            </div>
          `;
          div.addEventListener('click', () => {
            cityInput.value = city.name;
            autocompleteEl.classList.add('hidden');
            fetchWeatherByCity(city.name);
          });
          div.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              cityInput.value = city.name;
              autocompleteEl.classList.add('hidden');
              fetchWeatherByCity(city.name);
            }
          });
          autocompleteEl.appendChild(div);
        });
        autocompleteEl.classList.toggle('hidden', data.length === 0);
      } catch (error) {
        console.error('Autocomplete error:', error);
        autocompleteEl.classList.add('hidden');
      }
    }

    async function fetchUVIndex(lat, lon) {
      const cacheKey = `uvindex_${lat}_${lon}`;
      const cached = JSON.parse(localStorage.getItem(cacheKey));
      if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
        uvIndexEl.textContent = `${cached.data.uvi} (${getUVIndexText(cached.data.uvi)})`;
        uvIndexEl.title = getUVIndexAdvice(cached.data.uvi);
        return;
      }
      try {
        const response = await fetch(`https://api.openweathermap.org/data/2.5/uvi?lat=${lat}&lon=${lon}&appid=${apiKey}`);
        if (!response.ok) throw new Error('Unable to fetch UV index');
        const data = await response.json();
        const uvi = Math.round(data.value);
        localStorage.setItem(cacheKey, JSON.stringify({ data: { uvi }, timestamp: Date.now() }));
        uvIndexEl.textContent = `${uvi} (${getUVIndexText(uvi)})`;
        uvIndexEl.title = getUVIndexAdvice(uvi);
      } catch (error) {
        uvIndexEl.textContent = 'Unavailable';
        console.error('UV Index error:', error);
      }
    }

    function updateChartTheme() {
      if (tempChart) {
        tempChart.options.scales.y.grid.color = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        tempChart.options.scales.x.grid.color = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        tempChart.options.scales.y.ticks.color = isDarkMode ? '#fff' : '#000';
        tempChart.options.scales.x.ticks.color = isDarkMode ? '#fff' : '#000';
        tempChart.update();
      }
    }

    function displayTemperatureChart(data, timezoneOffset) {
      if (tempChart) {
        tempChart.destroy();
        tempChart = null;
      }
      const hourlyData = data.list
        .filter(item => {
          const now = new Date();
          return item.dt >= Math.floor(now.getTime() / 1000);
        })
        .slice(0, 12);

      if (hourlyData.length === 0) {
        tempChartCanvas.parentElement.innerHTML = '<p class="text-blue-100 text-center py-4 text-sm">No hourly data available for chart</p>';
        return;
      }

      const labels = hourlyData.map(hour => formatTime(hour.dt, timezoneOffset));
      const temperatures = hourlyData.map(hour => Math.round(hour.main.temp));

      tempChart = new Chart(tempChartCanvas, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: `Temperature (°${unit === 'metric' ? 'C' : 'F'})`,
            data: temperatures,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.2)',
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: isDarkMode ? '#fff' : '#000',
                font: { size: 12 }
              }
            },
            tooltip: {
              backgroundColor: isDarkMode ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.8)',
              titleColor: isDarkMode ? '#fff' : '#000',
              bodyColor: isDarkMode ? '#fff' : '#000',
              bodyFont: { size: 12 }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              grid: {
                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
              },
              ticks: {
                color: isDarkMode ? '#fff' : '#000',
                font: { size: 12 },
                callback: value => `${value}°${unit === 'metric' ? 'C' : 'F'}`
              }
            },
            x: {
              grid: {
                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
              },
              ticks: {
                color: isDarkMode ? '#fff' : '#000',
                font: { size: 12 },
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
    }

    function displayHourlyForecast(data, timezoneOffset) {
      hourlyForecastEl.innerHTML = '';
      const now = new Date();
      const currentTimestamp = Math.floor(now.getTime() / 1000);
      const hourlyData = data.list
        .filter(item => item.dt >= currentTimestamp)
        .slice(0, 12);

      if (hourlyData.length === 0) {
        hourlyForecastEl.innerHTML = '<p class="text-blue-100 text-center py-4 text-sm">No hourly forecast available</p>';
        return;
      }

      hourlyData.forEach(hour => {
        const time = formatTime(hour.dt, timezoneOffset);
        const temp = Math.round(hour.main.temp);
        const icon = hour.weather[0].icon;
        const pop = Math.round(hour.pop * 100);
        const hourlyCard = `
          <div class="hourly-card flex flex-col items-center transition-transform hover:scale-105">
            <p class="font-semibold text-sm">${time}</p>
            <img src="https://openweathermap.org/img/wn/${icon}.png" alt="${hour.weather[0].description}" class="w-12 h-12 my-2">
            <p class="font-medium">${temp}°${unit === 'metric' ? 'C' : 'F'}</p>
            <p class="text-sm mt-1 text-blue-100">${hour.weather[0].description}</p>
            <p class="text-xs text-blue-200 mt-1"><i class="fas fa-umbrella mr-1"></i>${pop}%</p>
          </div>
        `;
        hourlyForecastEl.insertAdjacentHTML('beforeend', hourlyCard);
      });
    }

    function displayDailyForecast(data) {
      forecastEl.innerHTML = '';
      const dailyData = data.list.filter(item => item.dt_txt.includes('12:00:00'));
      if (dailyData.length === 0) {
        forecastEl.innerHTML = '<p class="text-blue-100 text-center py-4 text-sm">No daily forecast available</p>';
        return;
      }
      dailyData.slice(0, 5).forEach(day => {
        const date = new Date(day.dt * 1000).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        const temp = Math.round(day.main.temp);
        const icon = day.weather[0].icon;
        const pop = Math.round(day.pop * 100);
        const forecastCard = `
          <div class="forecast-card flex flex-col items-center transition-transform hover:scale-[1.03]">
            <p class="font-semibold text-sm">${date}</p>
            <img src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="${day.weather[0].description}" class="w-16 h-16 my-2">
            <p class="font-medium text-xl">${temp}°${unit === 'metric' ? 'C' : 'F'}</p>
            <p class="text-blue-100 mt-2 text-sm">${day.weather[0].description}</p>
            <p class="text-xs text-blue-200 mt-1"><i class="fas fa-umbrella mr-1"></i>${pop}%</p>
          </div>
        `;
        forecastEl.insertAdjacentHTML('beforeend', forecastCard);
      });
    }

    function displayWeather(data) {
      currentWeatherData = data;
      errorEl.classList.add('hidden');
      const cityName = data.name.toLowerCase();
      favoriteBtn.querySelector('i').className = favoriteCities.includes(cityName) ? 'fas fa-star text-yellow-400' : 'fas fa-star text-lg';
      favoriteBtn.title = favoriteCities.includes(cityName) ? 'Remove from Favorites' : 'Add to Favorites';
      favoriteBtn.setAttribute('aria-label', favoriteCities.includes(cityName) ? 'Remove from Favorites' : 'Add to Favorites');
      locationEl.textContent = `${data.name}, ${data.sys.country}`;
      temperatureEl.textContent = `${Math.round(data.main.temp)}°${unit === 'metric' ? 'C' : 'F'}`;
      feelsLikeEl.textContent = `${Math.round(data.main.feels_like)}°${unit === 'metric' ? 'C' : 'F'}`;
      descriptionEl.textContent = data.weather[0].description;
      weatherIcon.src = `https://openweathermap.org/img/wn/${data.weather[0].icon}@4x.png`;
      weatherIcon.alt = data.weather[0].description;
      humidityEl.textContent = `${data.main.humidity}%`;
      windEl.textContent = `${data.wind.speed} ${unit === 'metric' ? 'm/s' : 'mph'}`;
      pressureEl.textContent = `${data.main.pressure} hPa`;
      visibilityEl.textContent = `${(data.visibility / 1000).toFixed(1)} km`;
      cloudsEl.textContent = `${data.clouds.all}%`;
      updateLocalTime(data.timezone);

      const sunriseTime = formatTime(data.sys.sunrise, data.timezone);
      const sunsetTime = formatTime(data.sys.sunset, data.timezone);
      sunriseEl.textContent = sunriseTime;
      sunsetEl.textContent = sunsetTime;

      alertsEl.classList.add('hidden');
      shareBtn.classList.remove('hidden');
      updateLastUpdated();
      saveRecentCity(data.name);
      retryCount = 0;

      fetchUVIndex(data.coord.lat, data.coord.lon);
    }

    function showError(message, isRetryable = false) {
      errorEl.textContent = message;
      errorEl.classList.remove('hidden');
      errorEl.setAttribute('role', 'alert');
      setTimeout(() => {
        errorEl.classList.add('hidden');
        errorEl.removeAttribute('role');
      }, 5000);
      locationEl.textContent = '';
      localTimeEl.textContent = '';
      temperatureEl.textContent = '';
      feelsLikeEl.textContent = '';
      descriptionEl.textContent = '';
      weatherIcon.src = '';
      weatherIcon.alt = '';
      humidityEl.textContent = '';
      windEl.textContent = '';
      pressureEl.textContent = '';
      visibilityEl.textContent = '';
      cloudsEl.textContent = '';
      sunriseEl.textContent = '';
      sunsetEl.textContent = '';
      uvIndexEl.textContent = '';
      alertsEl.classList.add('hidden');
      forecastEl.innerHTML = '';
      hourlyForecastEl.innerHTML = '';
      shareBtn.classList.add('hidden');
      favoriteBtn.querySelector('i').className = 'fas fa-star text-lg';
      favoriteBtn.title = 'Add to Favorites';
      favoriteBtn.setAttribute('aria-label', 'Add to Favorites');
      lastUpdatedEl.textContent = '';
      if (tempChart) {
        tempChart.destroy();
        tempChart = null;
      }

      if (isRetryable && retryCount < maxRetries) {
        setTimeout(() => fetchWeatherByCity(lastSearchedCity), 2000);
        retryCount++;
      }
    }

    async function fetchWeatherAlerts(lat, lon) {
      try {
        const response = await fetch(`https://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${lon}&exclude=minutely,hourly,daily&appid=${apiKey}`);
        if (!response.ok) throw new Error('Unable to fetch alerts');
        const data = await response.json();
        if (data.alerts && data.alerts.length > 0) {
          alertsEl.classList.remove('hidden');
          alertMessageEl.textContent = data.alerts[0].description;
          alertSenderEl.textContent = `Source: ${data.alerts[0].sender_name || 'Unknown'}`;
        } else {
          alertsEl.classList.add('hidden');
        }
      } catch (error) {
        alertsEl.classList.add('hidden');
        console.error('Weather alerts error:', error);
      }
    }

    async function fetchWeatherByCity(city) {
      if (!city || city.trim() === '') {
        showError('Please enter a city name');
        return;
      }
      setLoading(true);
      try {
        const normalizedCity = city.trim().toLowerCase();
        const cacheKey = `weather_${normalizedCity}_${unit}`;
        const forecastCacheKey = `forecast_${normalizedCity}_${unit}`;

        const cached = JSON.parse(localStorage.getItem(cacheKey));
        if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
          displayWeather(cached.data);
          const forecastCached = JSON.parse(localStorage.getItem(forecastCacheKey));
          if (forecastCached) {
            displayDailyForecast(forecastCached.data);
            displayHourlyForecast(forecastCached.data, cached.data.timezone);
            displayTemperatureChart(forecastCached.data, cached.data.timezone);
          }
          fetchWeatherAlerts(cached.data.coord.lat, cached.data.coord.lon);
          setLoading(false);
          return;
        }

        const weatherResponse = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&units=${unit}&appid=${apiKey}`);
        if (!weatherResponse.ok) {
          if (weatherResponse.status === 401) throw new Error('Invalid API key. Please check your API key.');
          if (weatherResponse.status === 404) throw new Error('City not found. Please try another city.');
          if (weatherResponse.status === 429) throw new Error('API rate limit exceeded. Please try again later.');
          throw new Error('Unable to fetch weather data. Please try again.');
        }
        const weatherData = await weatherResponse.json();
        localStorage.setItem(cacheKey, JSON.stringify({ data: weatherData, timestamp: Date.now() }));
        displayWeather(weatherData);

        const forecastResponse = await fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(city)}&units=${unit}&appid=${apiKey}`);
        if (!forecastResponse.ok) throw new Error('Forecast not available');
        const forecastData = await forecastResponse.json();
        localStorage.setItem(forecastCacheKey, JSON.stringify({ data: forecastData, timestamp: Date.now() }));
        displayDailyForecast(forecastData);
        displayHourlyForecast(forecastData, weatherData.timezone);
        displayTemperatureChart(forecastData, weatherData.timezone);

        fetchWeatherAlerts(weatherData.coord.lat, weatherData.coord.lon);
      } catch (error) {
        showError(error.message, error.message.includes('try again'));
      } finally {
        setLoading(false);
      }
    }

    async function fetchWeatherByCoords(lat, lon) {
      setLoading(true);
      try {
        const cacheKey = `weather_coords_${lat}_${lon}_${unit}`;
        const forecastCacheKey = `forecast_coords_${lat}_${lon}_${unit}`;

        const cached = JSON.parse(localStorage.getItem(cacheKey));
        if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
          displayWeather(cached.data);
          const forecastCached = JSON.parse(localStorage.getItem(forecastCacheKey));
          if (forecastCached) {
            displayDailyForecast(forecastCached.data);
            displayHourlyForecast(forecastCached.data, cached.data.timezone);
            displayTemperatureChart(forecastCached.data, cached.data.timezone);
          }
          fetchWeatherAlerts(cached.data.coord.lat, cached.data.coord.lon);
          setLoading(false);
          return;
        }

        const weatherResponse = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=${unit}&appid=${apiKey}`);
        if (!weatherResponse.ok) {
          if (weatherResponse.status === 429) throw new Error('API rate limit exceeded. Please try again later.');
          throw new Error('Unable to fetch weather data');
        }
        const weatherData = await weatherResponse.json();
        localStorage.setItem(cacheKey, JSON.stringify({ data: weatherData, timestamp: Date.now() }));
        displayWeather(weatherData);

        const forecastResponse = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=${unit}&appid=${apiKey}`);
        if (!forecastResponse.ok) throw new Error('Forecast not available');
        const forecastData = await forecastResponse.json();
        localStorage.setItem(forecastCacheKey, JSON.stringify({ data: forecastData, timestamp: Date.now() }));
        displayDailyForecast(forecastData);
        displayHourlyForecast(forecastData, weatherData.timezone);
        displayTemperatureChart(forecastData, weatherData.timezone);

        fetchWeatherAlerts(weatherData.coord.lat, weatherData.coord.lon);
      } catch (error) {
        showError(error.message, error.message.includes('try again'));
      } finally {
        setLoading(false);
      }
    }

    function debounce(func, wait) {
      return function (...args) {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    const eventListeners = [
      {
        element: searchBtn,
        event: 'click',
        handler: () => {
          const city = cityInput.value.trim();
          if (city) {
            fetchWeatherByCity(city);
            cityInput.value = '';
            clearInput.classList.add('hidden');
            autocompleteEl.classList.add('hidden');
          } else {
            showError('Please enter a city name');
          }
        }
      },
      {
        element: cityInput,
        event: 'input',
        handler: debounce(() => {
          const city = cityInput.value.trim();
          clearInput.classList.toggle('hidden', !city);
          fetchCitySuggestions(city);
        }, 300)
      },
      {
        element: cityInput,
        event: 'keypress',
        handler: (e) => {
          if (e.key === 'Enter') {
            const city = cityInput.value.trim();
            if (city) {
              fetchWeatherByCity(city);
              cityInput.value = '';
              clearInput.classList.add('hidden');
              autocompleteEl.classList.add('hidden');
            } else {
              showError('Please enter a city name');
            }
          }
        }
      },
      {
        element: clearInput,
        event: 'click',
        handler: () => {
          cityInput.value = '';
          clearInput.classList.add('hidden');
          autocompleteEl.classList.add('hidden');
          cityInput.focus();
        }
      },
      {
        element: geoBtn,
        event: 'click',
        handler: () => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                const { latitude, longitude } = position.coords;
                fetchWeatherByCoords(latitude, longitude);
              },
              () => {
                showError('Unable to access location. Please allow location access or enter a city name.');
              },
              { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
          } else {
            showError('Geolocation is not supported by your browser');
          }
        }
      },
      {
        element: unitToggle,
        event: 'click',
        handler: () => {
          unit = unit === 'metric' ? 'imperial' : 'metric';
          unitText.textContent = unit === 'metric' ? '°C' : '°F';
          localStorage.setItem('unit', unit);
          if (locationEl.textContent) {
            const city = locationEl.textContent.split(',')[0].trim();
            fetchWeatherByCity(city);
          }
        }
      },
      {
        element: themeToggle,
        event: 'click',
        handler: () => {
          setTheme(!isDarkMode);
        }
      },
      {
        element: favoriteBtn,
        event: 'click',
        handler: () => {
          if (!currentWeatherData) {
            showError('No city selected to add to favorites');
            return;
          }
          toggleFavoriteCity(currentWeatherData.name);
        }
      },
      {
        element: shareBtn,
        event: 'click',
        handler: async () => {
          if (!currentWeatherData) {
            showError('No weather data to share');
            return;
          }
          const shareData = {
            title: `Weather in ${currentWeatherData.name}`,
            text: `Current weather in ${currentWeatherData.name}: ${Math.round(currentWeatherData.main.temp)}°${unit === 'metric' ? 'C' : 'F'}, ${currentWeatherData.weather[0].description}.`,
            url: window.location.href,
          };
          try {
            if (navigator.share) {
              await navigator.share(shareData);
            } else {
              await navigator.clipboard.writeText(`${shareData.title}\n${shareData.text}\n${shareData.url}`);
              showError('Weather data copied to clipboard', false);
            }
          } catch (error) {
            showError('Failed to share weather data', false);
            console.error('Share error:', error);
          }
        }
      },
      {
        element: clearRecentBtn,
        event: 'click',
        handler: clearRecentSearches
      },
      {
        element: clearFavoritesBtn,
        event: 'click',
        handler: clearFavoriteCities
      },
      {
        element: cityInput,
        event: 'keydown',
        handler: (e) => {
          const items = autocompleteEl.querySelectorAll('.autocomplete-item');
          if (items.length === 0) return;
          let focusedIndex = -1;
          items.forEach((item, index) => {
            if (document.activeElement === item) focusedIndex = index;
          });

          if (e.key === 'ArrowDown') {
            e.preventDefault();
            focusedIndex = (focusedIndex + 1) % items.length;
            items[focusedIndex].focus();
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            focusedIndex = (focusedIndex - 1 + items.length) % items.length;
            items[focusedIndex].focus();
          } else if (e.key === 'Enter' && focusedIndex >= 0) {
            e.preventDefault();
            items[focusedIndex].click();
          }
        }
      }
    ];

    // Add event listeners
    eventListeners.forEach(({ element, event, handler }) => {
      element.addEventListener(event, handler);
    });
5
    // Cleanup function
    function cleanup() {
      eventListeners.forEach(({ element, event, handler }) => {
        element.removeEventListener(event, handler);
      });
      if (tempChart) {
        tempChart.destroy();
        tempChart = null;
      }
      clearTimeout(debounceTimeout);
    }

    // Add cleanup on page unload
    window.addEventListener('unload', cleanup);

    // Initialize
    setTheme(isDarkMode);
    updateRecentSearches();
    updateFavoriteCities();
    unitText.textContent = unit === 'metric' ? '°C' : '°F';
    if (lastSearchedCity) {
      fetchWeatherByCity(lastSearchedCity);
    }
  </script>
</body>
</html>